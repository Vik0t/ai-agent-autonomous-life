<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Hackathon - Virtual World Simulator</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .agent-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .agent-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            width: 150px;
            cursor: pointer;
        }
        .agent-card:hover {
            background-color: #f5f5f5;
        }
        .emotion-bar {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin: 5px 0;
            overflow: hidden;
        }
        .emotion-level {
            height: 100%;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .event-feed {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: white;
        }
        .event-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        #relationship-graph {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Main App Component
        class App extends React.Component {
            constructor(props) {
                super(props);
                this.state = {
                    agents: [],
                    events: [],
                    selectedAgent: null,
                    newEvent: "",
                    messageContent: "",
                    messageRecipient: "",
                    timeSpeed: 1.0
                };
            }

            componentDidMount() {
                this.fetchAgents();
                this.connectWebSocket();
                setInterval(() => this.fetchAgents(), 5000);
            }

            fetchAgents() {
                fetch('/agents')
                    .then(response => response.json())
                    .then(data => {
                        this.setState({ agents: data.agents });
                    })
                    .catch(error => console.error('Error fetching agents:', error));
            }

            connectWebSocket() {
                const ws = new WebSocket('ws://localhost:8000/ws');
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'event') {
                        this.addEvent(`Event: ${data.description}`);
                    } else if (data.type === 'message') {
                        this.addEvent(`Message: ${data.sender_id} -> ${data.receiver_id}: ${data.content}`);
                    } else {
                        // Update agent data
                        this.setState({ agents: data.agents || this.state.agents });
                        if (data.recent_messages) {
                            data.recent_messages.forEach(msg => {
                                this.addEvent(`Message: ${msg.sender_id} -> ${msg.receiver_id}: ${msg.content}`);
                            });
                        }
                    }
                };
            }

            addEvent(eventText) {
                const newEvent = {
                    id: Date.now(),
                    text: eventText,
                    timestamp: new Date().toLocaleTimeString()
                };
                this.setState(prevState => ({
                    events: [newEvent, ...prevState.events.slice(0, 49)] // Keep last 50 events
                }));
            }

            selectAgent(agent) {
                this.setState({ selectedAgent: agent });
            }

            addGlobalEvent() {
                if (!this.state.newEvent.trim()) return;
                
                fetch('/events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_description: this.state.newEvent })
                })
                .then(response => response.json())
                .then(data => {
                    this.addEvent(`Added event: ${this.state.newEvent}`);
                    this.setState({ newEvent: "" });
                })
                .catch(error => console.error('Error adding event:', error));
            }

            sendMessage() {
                if (!this.state.messageContent.trim() || !this.state.messageRecipient) return;
                
                fetch('/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sender_id: "user",
                        receiver_id: this.state.messageRecipient,
                        content: this.state.messageContent
                    })
                })
                .then(response => response.json())
                .then(data => {
                    this.addEvent(`Sent message to ${this.state.messageRecipient}: ${this.state.messageContent}`);
                    this.setState({ messageContent: "", messageRecipient: "" });
                })
                .catch(error => console.error('Error sending message:', error));
            }

            setTimeSpeed() {
                fetch('/control/speed', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ speed: this.state.timeSpeed })
                })
                .then(response => response.json())
                .then(data => {
                    this.addEvent(`Set time speed to ${this.state.timeSpeed}x`);
                })
                .catch(error => console.error('Error setting time speed:', error));
            }

            render() {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>Virtual World Simulator</h1>
                            <p>Observe and interact with autonomous AI agents</p>
                        </div>

                        <div className="dashboard">
                            <div className="panel">
                                <h2>Agents</h2>
                                <AgentList 
                                    agents={this.state.agents} 
                                    onSelectAgent={(agent) => this.selectAgent(agent)}
                                />
                            </div>

                            <div className="panel">
                                <h2>Control Panel</h2>
                                <div className="controls">
                                    <div className="control-group">
                                        <input
                                            type="text"
                                            placeholder="Global event description"
                                            value={this.state.newEvent}
                                            onChange={(e) => this.setState({ newEvent: e.target.value })}
                                        />
                                        <button onClick={() => this.addGlobalEvent()}>Add Event</button>
                                    </div>

                                    <div className="control-group">
                                        <select
                                            value={this.state.messageRecipient}
                                            onChange={(e) => this.setState({ messageRecipient: e.target.value })}
                                        >
                                            <option value="">Select recipient</option>
                                            {this.state.agents.map(agent => (
                                                <option key={agent.id} value={agent.id}>{agent.name}</option>
                                            ))}
                                        </select>
                                        <input
                                            type="text"
                                            placeholder="Message content"
                                            value={this.state.messageContent}
                                            onChange={(e) => this.setState({ messageContent: e.target.value })}
                                        />
                                        <button onClick={() => this.sendMessage()}>Send Message</button>
                                    </div>

                                    <div className="control-group">
                                        <label>Time Speed:</label>
                                        <input
                                            type="range"
                                            min="0.1"
                                            max="5"
                                            step="0.1"
                                            value={this.state.timeSpeed}
                                            onChange={(e) => this.setState({ timeSpeed: parseFloat(e.target.value) })}
                                        />
                                        <span>{this.state.timeSpeed}x</span>
                                        <button onClick={() => this.setTimeSpeed()}>Set Speed</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="dashboard">
                            <div className="panel">
                                <h2>Event Feed</h2>
                                <EventFeed events={this.state.events} />
                            </div>

                            <div className="panel">
                                <h2>Relationship Graph</h2>
                                <RelationshipGraph agents={this.state.agents} />
                            </div>
                        </div>

                        {this.state.selectedAgent && (
                            <div className="panel">
                                <h2>Agent Inspector: {this.state.selectedAgent.name}</h2>
                                <AgentInspector agent={this.state.selectedAgent} />
                            </div>
                        )}
                    </div>
                );
            }
        }

        // Agent List Component
        class AgentList extends React.Component {
            render() {
                return (
                    <div className="agent-list">
                        {this.props.agents.map(agent => (
                            <AgentCard 
                                key={agent.id} 
                                agent={agent} 
                                onClick={() => this.props.onSelectAgent(agent)} 
                            />
                        ))}
                    </div>
                );
            }
        }

        // Agent Card Component
        class AgentCard extends React.Component {
            getMoodColor() {
                const emotions = this.props.agent.emotions;
                if (emotions.happiness > 0.5) return '#4CAF50';
                if (emotions.sadness > 0.5) return '#2196F3';
                if (emotions.anger > 0.5) return '#F44336';
                return '#9E9E9E';
            }

            render() {
                const agent = this.props.agent;
                const moodColor = this.getMoodColor();

                return (
                    <div className="agent-card" onClick={this.props.onClick}>
                        <h3>{agent.name}</h3>
                        <div className="emotion-bar">
                            <div 
                                className="emotion-level" 
                                style={{ 
                                    width: `${agent.emotions.happiness * 100}%`, 
                                    backgroundColor: moodColor 
                                }}
                            ></div>
                        </div>
                        <p>Memories: {agent.memory_count}</p>
                    </div>
                );
            }
        }

        // Event Feed Component
        class EventFeed extends React.Component {
            render() {
                return (
                    <div className="event-feed">
                        {this.props.events.map(event => (
                            <div key={event.id} className="event-item">
                                <strong>{event.timestamp}</strong>: {event.text}
                            </div>
                        ))}
                    </div>
                );
            }
        }

        // Relationship Graph Component
        class RelationshipGraph extends React.Component {
            componentDidMount() {
                this.drawGraph();
            }

            componentDidUpdate() {
                this.drawGraph();
            }

            drawGraph() {
                const width = 500;
                const height = 300;
                const svg = d3.select("#relationship-graph");

                // Clear previous graph
                svg.selectAll("*").remove();

                if (this.props.agents.length < 2) return;

                // Create nodes
                const nodes = this.props.agents.map(agent => ({
                    id: agent.id,
                    name: agent.name
                }));

                // Create links based on relationships
                const links = [];
                this.props.agents.forEach(agent => {
                    Object.keys(agent.relationships).forEach(relId => {
                        const relationship = agent.relationships[relId];
                        links.push({
                            source: agent.id,
                            target: relId,
                            affinity: relationship.affinity
                        });
                    });
                });

                // Create SVG container
                const g = svg
                    .attr("width", width)
                    .attr("height", height)
                    .append("g");

                // Create force simulation
                const simulation = d3.forceSimulation(nodes)
                    .force("link", d3.forceLink(links).id(d => d.id).distance(100))
                    .force("charge", d3.forceManyBody().strength(-200))
                    .force("center", d3.forceCenter(width / 2, height / 2));

                // Draw links
                const link = g.append("g")
                    .selectAll("line")
                    .data(links)
                    .enter()
                    .append("line")
                    .style("stroke", d => d.affinity > 0 ? "#4CAF50" : "#F44336")
                    .style("stroke-width", d => Math.abs(d.affinity) * 3 + 1);

                // Draw nodes
                const node = g.append("g")
                    .selectAll("circle")
                    .data(nodes)
                    .enter()
                    .append("circle")
                    .attr("r", 10)
                    .style("fill", "#2196F3")
                    .call(d3.drag()
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended));

                // Add labels
                const label = g.append("g")
                    .selectAll("text")
                    .data(nodes)
                    .enter()
                    .append("text")
                    .text(d => d.name)
                    .attr("x", 12)
                    .attr("y", 4);

                // Update positions
                simulation.on("tick", () => {
                    link
                        .attr("x1", d => d.source.x)
                        .attr("y1", d => d.source.y)
                        .attr("x2", d => d.target.x)
                        .attr("y2", d => d.target.y);

                    node
                        .attr("cx", d => d.x)
                        .attr("cy", d => d.y);

                    label
                        .attr("x", d => d.x + 12)
                        .attr("y", d => d.y + 4);
                });

                // Drag functions
                function dragstarted(event, d) {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                }

                function dragged(event, d) {
                    d.fx = event.x;
                    d.fy = event.y;
                }

                function dragended(event, d) {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }
            }

            render() {
                return <svg id="relationship-graph"></svg>;
            }
        }

        // Agent Inspector Component
        class AgentInspector extends React.Component {
            render() {
                const agent = this.props.agent;
                return (
                    <div>
                        <h3>Personality</h3>
                        <ul>
                            <li>Openness: {agent.personality.openness.toFixed(2)}</li>
                            <li>Conscientiousness: {agent.personality.conscientiousness.toFixed(2)}</li>
                            <li>Extraversion: {agent.personality.extraversion.toFixed(2)}</li>
                            <li>Agreeableness: {agent.personality.agreeableness.toFixed(2)}</li>
                            <li>Neuroticism: {agent.personality.neuroticism.toFixed(2)}</li>
                        </ul>

                        <h3>Current Emotions</h3>
                        <ul>
                            <li>Happiness: {agent.emotions.happiness.toFixed(2)}</li>
                            <li>Sadness: {agent.emotions.sadness.toFixed(2)}</li>
                            <li>Anger: {agent.emotions.anger.toFixed(2)}</li>
                            <li>Fear: {agent.emotions.fear.toFixed(2)}</li>
                            <li>Surprise: {agent.emotions.surprise.toFixed(2)}</li>
                            <li>Disgust: {agent.emotions.disgust.toFixed(2)}</li>
                        </ul>

                        <h3>Relationships</h3>
                        <ul>
                            {Object.keys(agent.relationships).map(relId => {
                                const relationship = agent.relationships[relId];
                                return (
                                    <li key={relId}>
                                        Agent {relId}: Affinity {relationship.affinity.toFixed(2)}, 
                                        Familiarity {relationship.familiarity.toFixed(2)}
                                    </li>
                                );
                            })}
                        </ul>
                    </div>
                );
            }
        }

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>